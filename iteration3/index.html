<!DOCTYPE html>
<html>
    <head>

        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    </head>
    
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-route.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.js"></script>
    <script src="http://rawgit.com/angular-ui/angular-google-maps/2.0.X/dist/angular-google-maps.js"></script>

<body ng-app="myApp">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <h1 class="navbar-brand">Plan Your Travel 2</h1>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link" href="#/home">Home <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link"  href="#!about">About Us</a>
        </li>
        <li class="nav-item">
          <a class="nav-link"  href="#!contact">Contact Us</a>
        </li>
        <li class="nav-item">
            <a class="nav-link"  href="#!search">Search</a>
          </li>
          <li class="nav-item">
            <a class="nav-link"  href="#!login">Login</a>
          </li>
     </ul>
    </div>
  </nav>
  <div ng-view>
    

  </div>


<script>
'use strict';
var app = angular.module("myApp", ["uiGmapgoogle-maps","ngRoute"]);
app.config(function($routeProvider) {
    $routeProvider
    .when("/login",{
      resolve: {
			check: function($location, user) {
				if(user.isUserLoggedIn()) {
					$location.path('/dashboard');
				}
			},
		},
      templateUrl: "login.html",
      controller : "loginController"
    })
    .when("/", {
        templateUrl : "home.html",
        controller : "mapCtrl"
    })
    .when("/about", {
        templateUrl : "about.html",
        controller : "aboutController"
    })
    .when("/contact", {
        templateUrl : "contact.html",
        controller : "contactController"
    })
    .when("/search",{
        templateUrl :"search.html",
        controller: "searchController"
    })
    .when('/dashboard',{
      resolve: {
			check: function($location, user) {
				if(!user.isUserLoggedIn()) {
					$location.path('/login');
				}
			},
		},
		    templateUrl: 'dashboard.html',
        controller: 'dashboardController'
    })
    .when('/logout',{
      resolve: {
        deadResolve: function($location,user){
          user.clearData();
          $location.path('/login');
        }
      }
    })
    .when("/dashboardreg",{
        templateUrl :"notadmindash.html",
        controller: "notadmindashcontroller"
    })
    .otherwise({redirectTo:"/home"});
});
app.service('user', function() {
	var username;
	var loggedin = false;
	var id;

	this.getName = function() {
		return username;
	};

	this.setID = function(userID) {
		id = userID;
	};
	this.getID = function() {
		return id;
	};

  this.isUserLoggedIn = function() {
    if(!!localStorage.getItem('login')) {
			loggedin = true;
			var data = JSON.parse(localStorage.getItem('login'));
			username = data.username;
			id = data.id;
		}
		return loggedin;
	};
  this.saveData = function(data){
    username = data.user;
    id =data.id;
    loggedin = true;
    localStorage.setItem('login', JSON.stringify({
        username: username,
        id: id
    }));
  };
	this.clearData = function() {
		localStorage.removeItem('login');
		username = "";
		id = "";
		loggedin = false;
	};
});

app
.config(['$locationProvider', '$routeProvider', function ($locationProvider, $routeProvider) {
  //$locationProvider.hashPrefix('!');
  //$routeProvider.otherwise({ redirectTo: '/view1' });
}])
.config(function (uiGmapGoogleMapApiProvider) {
  uiGmapGoogleMapApiProvider.configure({
    key: 'AIzaSyACWTlnsvRfilkzCbmEn7-TsVUvdWZtoHg',
    v: '3.20', //defaults to latest 3.X anyhow
    libraries: 'weather,geometry,visualization'
  });
})
.controller('mapCtrl', function($scope, uiGmapGoogleMapApi) {
    uiGmapGoogleMapApi.then(function(maps) {
        $scope.map = { center: { latitude: 45, longitude: -73 }, zoom: 8 };
    });
});

app.controller("aboutController", function ($scope) {

});
app.controller("contactController", function ($scope) {

});
app.controller("notadmindashcontroller", function ($scope) {

});
app.controller("searchController", function ($scope,$http) {
  $http.get("search.php")
   .then(function (response) {
   $scope.locdata = response.data;});
   $scope.image = "images/1.jpg";
    $scope.name= "Eiffel Tower";
    $scope.description = "The Eiffel Tower is a wrought-iron lattice tower on the Champ de Mars in Paris, France. It is named after the engineer Gustave Eiffel, whose company designed and built the tower.";
    $scope.price ="3000.99";
    $scope.onClick = function(obj){
        $scope.name = obj.name;
        $scope.image = obj.image;
        $scope.description = obj.description;
        $scope.price = obj.price;
    };
});
app.controller("loginController", function ($scope, $http, $location, user) {
    $scope.login = function(){
      var username = $scope.username;
      var password = $scope.password;
      $http({
        url: "http://localhost/cps630/iteration3/server.php",
        method: 'POST',
        headers:{
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        data: 'username='+username+'&password='+password
      }).then(function(response){
        if(response.data.status == 'loggedadmin'){
          user.saveData(response.data);
          console.log("admin");
          $location.path('/dashboard');
        }
        else{
          $location.path('/dashboardreg');
        }
      })
      }
    $scope.register=function(){
      if($scope.registerForm.$valid){
         $http.post(
          "register.php", {
          'username1': $scope.username1,
          'password1': $scope.password1,
          'email': $scope.email,
          'fname': $scope.fname,
          'lname': $scope.lname,
          'address': $scope.email,
          'phone': $scope.phone
          }
          ).then(function(response) {
          console.log(response.data);
          $scope.username1= null;
          $scope.password1= null;
          $scope.email= null;
          $scope.fname= null;
          $scope.lname= null;
          $scope.address= null;
          $scope.phone= null;
          });
          }
    }
});
app.controller("dashboardController",function($scope, user, $http){
  $scope.user = user.getName();
  $http.get("dashboard.php")
   .then(function (response) {
   $scope.userdata = response.data;
   });
   $http.get("search.php")
   .then(function (response) {
   $scope.searchdata = response.data;
   });

});
app.config(['$httpProvider', function($httpProvider) {
    if (!$httpProvider.defaults.headers.get) {
        $httpProvider.defaults.headers.get = {};    
    }    
    $httpProvider.defaults.headers.get['If-Modified-Since'] = 'Mon, 26 Jul 1997 05:00:00 GMT';
    $httpProvider.defaults.headers.get['Cache-Control'] = 'no-cache';
    $httpProvider.defaults.headers.get['Pragma'] = 'no-cache';
}]);


</script>

</body>
</html>